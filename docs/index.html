<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

    <title>[:js2neo]</title>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="dist/js2neo.min.js"></script>

    <!-- noppa/text-security -->
    <link rel="stylesheet" type="text/css" href="https://rawgit.com/noppa/text-security/master/dist/text-security.css">

    <style>
        textarea, table { font-family: monospace }
        .text-security {
            font-family: "text-security-disc"
        }

    </style>
  </head>
  <body style="overflow-y:scroll">

    <div class="container">

        <h1 style="position: relative; text-align: center;padding: 2rem 0">
            <img src="art/js2neo-2018.280x50.png">

            <!-- AddToAny BEGIN -->
            <div class="a2a_kit a2a_kit_size_32 a2a_default_style" style="position: absolute; top: 2rem; right: 0">
            <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
            <a class="a2a_button_facebook"></a>
            <a class="a2a_button_twitter"></a>
            <a class="a2a_button_google_plus"></a>
            </div>
            <script async src="https://static.addtoany.com/menu/page.js"></script>
            <!-- AddToAny END -->

        </h1>

        <p>
            Js2neo is a tiny Neo4j connector for JavaScript.
            It contains the bare minimum required to run Cypher queries over Bolt.
        </p>

        <h2>Download</h2>
        <div class="form-group">
            <a class="btn btn-primary btn-lg" href="dist/js2neo.min.js">js2neo.min.js</a>
            <!--a class="btn btn-primary btn-lg" href="dist/js2neo.js">Download <em>js2neo.js</em></a-->

        </div>

        <h2>Quick Example</h2>
        <div class="form-group">
<pre><code>js2neo.bolt({password: "password"}).run("RETURN $x", {params: {x: "hello, world"}, onRecord: console.log})
</code></pre>
        </div>

        <form id="connection-form">
            <h2>Test Connection</h2>
            <div class="form-group row">
                <div class="col">
                    <label for="host">Host</label>
                    <input class="form-control" id="host" placeholder="Enter the server host name or IP address"
                           value="localhost">
                </div>
                <div class="col">
                    <label for="port">Port</label>
                    <input type="number" class="form-control" id="port" placeholder="Enter the server port number"
                           value="7687">
                </div>
            </div>
            <div class="form-group row">
                <div class="col">
                    <label for="host">User</label>
                    <input class="form-control" id="user" placeholder="Enter your user name" value="neo4j">
                </div>
                <div class="col" id="password-here">
                    <label for="password">Password</label>
                    <input type="text" class="form-control text-security" id="password">
                </div>
            </div>
            <div class="form-group">
                <button id="connect-button" type="button" class="btn btn-primary" onclick="connect()">Connect</button>
                <button id="disconnect-button" type="button" class="btn btn-primary" onclick="disconnect()"
                        disabled="disabled">Disconnect
                </button>
            </div>
            <div class="form-group" id="connection-management-status">
            </div>
        </form>

        <form id="query-form">
            <h2>Test Cypher Execution</h2>
            <div class="form-group row">
                <div class="col-12">
                    <label for="cypher">Statement</label>
                    <textarea class="form-control" id="cypher" style="width:100%;height:7.5rem" title="Cypher query">MATCH (a:Person)-[:ACTED_IN]->(m) WHERE a.name =~ 'K.*'
RETURN a.name, a.born, collect(m.title)</textarea>
                </div>
                <!--<div class="col-4">-->
                    <!--<label for="params">Parameters</label>-->
                    <!--<select id="params" class="custom-select" size="3" style="height:7.5rem">-->
                    <!--</select>-->
                <!--</div>-->
            </div>
            <div class="form-group">
                <button id="run-button" type="button" class="btn btn-primary" onclick='run($("#cypher").val())'
                        disabled="disabled">Run
                </button>
            </div>
        </form>

        <form id="result-form">
            <h2>Result</h2>
            <table id="result" class="table table-hover">
                <thead id="result-head" class="thead-dark"></thead>
                <tbody id="result-body"></tbody>
                <tfoot id="result-foot" class="thead-dark"></tfoot>
            </table>
        </form>

        <div class="py-3 text-center">
        Copyright &copy; 2011-2018 Nigel Small
    </div>

    </div>

    <script>

        $("#result-form").hide();

        var pub = {};

        function clearConnectionManagementStatus() {
            var status = document.getElementById("connection-management-status");
            while (status.firstChild) status.removeChild(status.firstChild);
        }

        function addConnectionManagementStatus(level, message) {
            var status = document.getElementById("connection-management-status"),
                div = document.createElement("div"),
                text = document.createTextNode(message);
            div.setAttribute("class", "alert alert-" + level);
            div.setAttribute("role", "alert");
            status.appendChild(div);
            div.appendChild(text);
        }

        function setConnected(connected) {
            if (connected) {
                $("#run-button").removeAttr("disabled");
                $("#connect-button").attr("disabled", "disabled");
                $("#disconnect-button").removeAttr("disabled");
            } else {
                $("#run-button").attr("disabled", "disabled");
                $("#connect-button").removeAttr("disabled");
                $("#disconnect-button").attr("disabled", "disabled");
            }
        }

        function connect() {
            clearConnectionManagementStatus();
            pub.bolt = js2neo.bolt({
                host: document.getElementById("host").value,
                port: parseInt(document.getElementById("port").value),
                user: document.getElementById("user").value,
                password: document.getElementById("password").value,
                onOpen: function(metadata) {
                    // for (var key in metadata) {
                    //     if (metadata.hasOwnProperty(key)) pub[key] = metadata[key];
                    // }
                    // addConnectionManagementStatus("success", "Connected to " + pub.host + " on port " + pub.port);
                },
                onHandshake: function(metadata) {
                    // for (var key in metadata) {
                    //     if (metadata.hasOwnProperty(key)) pub[key] = metadata[key];
                    // }
                    // addConnectionManagementStatus("success", "Using Bolt protocol v" + pub.protocolVersion);
                },
                onInit: function(metadata) {
                    for (var key in metadata) {
                        if (metadata.hasOwnProperty(key)) pub[key] = metadata[key];
                    }
                    addConnectionManagementStatus("success", "Connected with Bolt v" + pub.protocolVersion + " to " + pub.host + " on port " + pub.port + " as user " + pub.user);
                    setConnected(true);
                },
                onInitFailure: function(failure) {
                    addConnectionManagementStatus("danger", failure.code + ": " + failure.message);
                    setConnected(false);
                },
                onClose: function(event) {
                    //addConnectionManagementStatus("info", "Connection closed");
                    setConnected(false);
                    pub.bolt = undefined;
                },
                onError: function(event)
                {
                    addConnectionManagementStatus("danger", event);
                }
            });
        }

        function disconnect() {
            clearConnectionManagementStatus();
            pub.bolt.close();
        }

        function run(cypher) {
            // Clear any existing result
            var head = document.getElementById("result-head"),
                body = document.getElementById("result-body"),
                foot = document.getElementById("result-foot");
            while (head.firstChild) head.removeChild(head.firstChild);
            while (body.firstChild) body.removeChild(body.firstChild);
            while (foot.firstChild) foot.removeChild(foot.firstChild);

            var fields = [],
                count = 0,
                t0 = new Date();

            pub.bolt.run(cypher, {
                onHeader: function (metadata) {
                    $("#result-form").show();
                    var tr = document.createElement("tr");
                    for (var i = 0; i < metadata.fields.length; i++) {
                        fields.push(metadata.fields[i]);
                        var th = document.createElement("th");
                        th.appendChild(document.createTextNode(fields[i]));
                        tr.appendChild(th);
                    }
                    head.appendChild(tr)
                },
                onRecord: function (fields) {
                    count += 1;
                    var tr = document.createElement("tr");
                    for (var i = 0; i < fields.length; i++) {
                        var td = document.createElement("td");
                        var div = document.createElement("div");
                        var value = fields[i], text;
                        if (typeof value === "string") {
                            text = value;
                        }
                        else if (typeof value === "object" && !Array.isArray(value)) {
                            div.setAttribute("style", "white-space: pre");
                            text = value.constructor.name + "(" + JSON.stringify(value, null, "  ") + ")";
                        }
                        else {
                            text = JSON.stringify(value);
                        }
                        div.appendChild(document.createTextNode(text));
                        td.appendChild(div);
                        tr.appendChild(td);
                    }
                    body.appendChild(tr)
                },
                onFooter: function (metadata) {
                    var time = new Date() - t0;
                    var tr = document.createElement("tr");
                    var th = document.createElement("th");
                    th.setAttribute("colspan", "" + fields.length);
                    var server = pub.user + "@" + pub.host + ":" + pub.port;
                    th.appendChild(document.createTextNode(
                        count + " record" + (count === 1 ? "" : "s") +
                        " received from " + server + " in " + time + "ms"));
                    tr.appendChild(th);
                    foot.appendChild(tr)
                },
                onFailure: function (failure) {
                    console.log(failure.code + ": " + failure.message);
                }
            });
        }

    </script>

  </body>
</html>
