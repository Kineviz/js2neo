<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="cdn/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

    <title>js2neo</title>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="cdn/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="cdn/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="cdn/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="dist/js2neo.min.js"></script>
    <script src="sizes.js"></script>

    <!-- noppa/text-security -->
    <link rel="stylesheet" type="text/css" href="cdn/text-security.css">

      <style>
          h2 {
              margin: 2rem 0 1rem 0;
          }

          textarea, table.result {
              font-family: monospace
          }

          .text-security {
              font-family: "text-security-disc"
          }

          code {
              font-size: 1rem;
          }

          pre {
              padding: .5rem .8rem;
              font-size: 1rem;
              line-height: 1.5;
              border-radius: .3rem;
              background-color: #F0F0EC;
          }

      </style>
  </head>
  <body style="overflow-y:scroll">

  <div class="container">

      <h1 style="text-align: center;padding: 3rem 0">
          <img src="art/js2neo-2018.280x50.png">
      </h1>

      <p>
          The <strong>js2neo</strong> library is a tiny Neo4j connector for JavaScript.
          It contains the bare minimum required to run Cypher queries in a little over 2KB when gzipped.
          No support for transactions or routing is provided.
      </p>

      <div style="margin:1.5rem 0; text-align: center">
          <a class="btn btn-success btn-lg" href="dist/js2neo.min.js"
             style="text-align: left;margin-right:1rem;padding-right:6rem">
              <div style="font-size:250%;float:left;padding-right:1rem;">⇩</div>
              <div style="font-size:150%">Download <strong>js2neo.min.js</strong></div>
              <small><em>
                  (<script>document.write(sizes["js2neo.min.js"])</script> bytes,
                   <script>document.write(sizes["js2neo.min.js.gz"])</script> bytes gzipped)</em></small>
          </a>
          <a class="btn btn-secondary btn-lg" href="https://github.com/technige/js2neo"
             style="text-align: left;margin-right:1rem;padding-right:8rem">
              <div style="font-size:250%;float:left;padding-right:1rem;">⌨</div>
              <div style="font-size:150%">Get the code</div>
              <small><em>https://github.com/technige/js2neo</em></small>
          </a>
          <!--
          <a class="btn btn-success btn-lg" href="dist/js2neo.js"
             style="text-align: left;margin-right:1rem;padding-right:6rem">
              <div style="font-size:250%;float:left;padding-right:1rem;">⇩</div>
              <div style="font-size:150%">Download <strong>js2neo.js</strong></div>
              <small><em>(
                  <script>document.write(sizes["js2neo.js"])</script>
                  bytes)</em></small>
          </a>
          -->
      </div>

      <h2>Installation</h2>
      <p>
          To use this in a web page, download the <code>js2neo.min.js</code> file (above) or insert the following <code>&lt;script&gt;</code> tag:
          <pre><code>&lt;script src=&quot;http://js2neo.org/dist/js2neo.min.js&quot;&gt;&lt;/script&gt;</code></pre>
      </p>

      <h2>Usage</h2>
      <div class="card">
          <div class="card-header">
            <a role="button" class="btn btn-link" data-toggle="collapse" data-target="#api-open" aria-expanded="true" aria-controls="collapseOne">
              <code>var cx = js2neo.open(<em>settings</em>);</code>
            </a>
          </div>
          <div class="card-body collapse" id="api-open">
              <p>
                  Once installed, call the <code>js2neo.open</code> method with settings for your database.
                  This returns a connection object that wraps a single web socket connection and which can be used to <code>run</code> queries.
                  For example:
                  <pre><code>var cx = js2neo.open({host: "graph.example.com", user: "technige", password: "P4ssw0rd!"})</code></pre>
              </p>

              <p>The following arguments are supported:</p>
              <table class="table">
                  <tr><th>Name</th><th>Type</th><th>Description</th></tr>
                  <tr><td>secure</td><td>boolean</td><td>A flag to indicate whether or not to use a secure web socket.</td></tr>
                  <tr><td>user</td><td>string</td><td>The name of the user as which to authenticate.</td></tr>
                  <tr><td>password</td><td>string</td><td>The password for the given user.</td></tr>
                  <tr><td>host</td><td>string</td><td>The host name or IP address of the database server.</td></tr>
                  <tr><td>port</td><td>number</td><td>The port number of the database server.</td></tr>
                  <tr><td>userAgent</td><td>string</td><td>A custom user agent string.</td></tr>
              </table>

              <p>In addition, the following event handlers can be specified:</p>
              <table class="table">
                  <tr><th>Name</th><th>Signature</th><th>Description</th></tr>
                  <tr><td>onOpen</td><td>function(metadata)</td><td>
                      Called when a web socket connection is successfully established.
                      The event passes connection <code>metadata</code> containing <code>secure</code>, <code>user</code>, <code>host</code>, <code>port</code> and <code>userAgent</code> attributes.
                  </td></tr>
                  <tr><td>onHandshake</td><td>function(metadata)</td><td>
                      Called after the handshake that immediately follows a successful connection.
                      This adds a <code>protocolVersion</code> to the connection <code>metadata</code>.
                  </td></tr>
                  <tr><td>onInit</td><td>function(metadata)</td><td>
                      Called with connection <code>metadata</code> on successful initialisation, following the handshake.
                      This is the final stage of setup for a Bolt connection and therefore receipt of this event indicates that the connection is ready to run Cypher queries.
                  </td></tr>
                  <tr><td>onInitFailure</td><td>function(failure)</td><td>
                      Called if initialisation fails, generally due to an authentication error.
                      The event passed represents the failure that occurred and contains <code>code</code> and <code>message</code> attributes.
                      On receipt of this event, the connection can be deemed defunct.
                  </td></tr>
                  <tr><td>onClose</td><td>function(event)</td><td>
                      Called when the underlying web socket is closed, either gracefully or through error.
                      The <code>event</code> is a regular web socket <a href="https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent"><code>CloseEvent</code></a>.
                  </td></tr>
              </table>
          </div>
      </div>

      <br>

      <div class="card">
          <div class="card-header">
            <a role="button" class="btn btn-link" data-toggle="collapse" data-target="#api-run" aria-expanded="true" aria-controls="collapseOne">
                <code>cx.run(<em>cypher</em>, <em>parameters</em>, <em>eventHandlers</em>);</code>
            </a>
          </div>
          <div class="card-body collapse" id="api-run">
              <p>
                  To run a query, call <code>run</code> on the connection object:
              <pre><code>cx.run("RETURN $x", {x: "hello, world"}, {onRecord: console.log})</code></pre>
              </p>
          </div>
      </div>

      <br>

      <div class="card">
          <div class="card-header">
            <a role="button" class="btn btn-link" data-toggle="collapse" data-target="#api-close" aria-expanded="true" aria-controls="collapseOne">
              <code>cx.close();</code>
            </a>
          </div>
          <div class="card-body collapse" id="api-close">
          </div>
      </div>

      <h2><a name="demo">Demo</a></h2>
        <form id="connection-form">
            <div class="form-group row">
                <div class="col">
                    <label for="host">Host</label>
                    <input class="form-control" id="host" placeholder="Enter the server host name or IP address"
                           value="localhost">
                </div>
                <div class="col">
                    <label for="port">Port</label>
                    <input type="number" class="form-control" id="port" placeholder="Enter the server port number"
                           value="7687">
                </div>
            </div>
            <div class="form-group row">
                <div class="col">
                    <label for="host">User</label>
                    <input class="form-control" id="user" placeholder="Enter your user name" value="neo4j">
                </div>
                <div class="col" id="password-here">
                    <label for="password">Password</label>
                    <input type="text" class="form-control text-security" id="password">
                </div>
            </div>
            <div class="form-group">
                <button id="connect-button" type="button" class="btn btn-primary" onclick="connect()">Connect</button>
                <button id="disconnect-button" type="button" class="btn btn-primary" onclick="disconnect()"
                        disabled="disabled">Disconnect
                </button>
            </div>
            <div class="form-group" id="connection-management-status">
            </div>
        </form>

        <form id="query-form">
            <div class="form-group row">
                <div class="col-12">
                    <label for="cypher">Statement</label>
                    <textarea class="form-control" id="cypher" style="width:100%;height:7.5rem" title="Cypher query">MATCH (a:Person)-[:ACTED_IN]->(m) WHERE a.name =~ 'K.*'
RETURN a.name, a.born, collect(m.title)</textarea>
                </div>
                <!--<div class="col-4">-->
                    <!--<label for="params">Parameters</label>-->
                    <!--<select id="params" class="custom-select" size="3" style="height:7.5rem">-->
                    <!--</select>-->
                <!--</div>-->
            </div>
            <div class="form-group">
                <button id="run-button" type="button" class="btn btn-primary" onclick='run($("#cypher").val())'
                        disabled="disabled">Run
                </button>
            </div>
        </form>

        <form id="result-form">
            <h2>Result</h2>
            <table id="result" class="result table table-hover">
                <thead id="result-head" class="thead-dark"></thead>
                <tbody id="result-body"></tbody>
                <tfoot id="result-foot" class="thead-dark"></tfoot>
            </table>
        </form>

        <div class="py-3 text-center">
        Copyright &copy; 2011-2018 Nigel Small
    </div>

    </div>

    <script>

        $("#result-form").hide();

        var pub = {};

        function setConnectionManagementStatus(level, message) {
            var status = document.getElementById("connection-management-status"),
                div = document.createElement("div"),
                text = document.createTextNode(message);
            while (status.firstChild) status.removeChild(status.firstChild);
            if (level) {
                div.setAttribute("class", "alert alert-" + level);
                div.setAttribute("role", "alert");
                status.appendChild(div);
                div.appendChild(text);
            }
        }

        function setConnected(connected) {
            if (connected) {
                $("#run-button").removeAttr("disabled");
                $("#connect-button").attr("disabled", "disabled");
                $("#disconnect-button").removeAttr("disabled");
            } else {
                $("#run-button").attr("disabled", "disabled");
                $("#connect-button").removeAttr("disabled");
                $("#disconnect-button").attr("disabled", "disabled");
            }
        }

        function connect() {
            pub.cx = js2neo.open({
                host: document.getElementById("host").value,
                port: parseInt(document.getElementById("port").value),
                user: document.getElementById("user").value,
                password: document.getElementById("password").value,
                onOpen: function(metadata) {
                    // for (var key in metadata) {
                    //     if (metadata.hasOwnProperty(key)) pub[key] = metadata[key];
                    // }
                    // setConnectionManagementStatus("success", "Connected to " + pub.host + " on port " + pub.port);
                },
                onHandshake: function(metadata) {
                    // for (var key in metadata) {
                    //     if (metadata.hasOwnProperty(key)) pub[key] = metadata[key];
                    // }
                    // setConnectionManagementStatus("success", "Using Bolt protocol v" + pub.protocolVersion);
                },
                onInit: function(metadata) {
                    for (var key in metadata) {
                        if (metadata.hasOwnProperty(key)) pub[key] = metadata[key];
                    }
                    setConnectionManagementStatus("success", "Connected with Bolt v" + pub.protocolVersion + " to " + pub.host + " on port " + pub.port + " as user " + pub.user);
                    setConnected(true);
                },
                onInitFailure: function(failure) {
                    setConnectionManagementStatus("danger", failure.code + ": " + failure.message);
                    setConnected(false);
                },
                onClose: function(event) {
                    switch (event.code)
                    {
                        case 1000:
                        case 1001:
                            setConnectionManagementStatus();
                            break;
                        case 1006:
                            setConnectionManagementStatus("danger", "Connection failed");
                            break;
                        default:
                            setConnectionManagementStatus("danger", "Connection failed with code " + event.code);
                    }
                    setConnected(false);
                    pub.cx = undefined;
                }
            });
        }

        function disconnect() {
            pub.cx.close();
        }

        function run(cypher) {
            // Clear any existing result
            var head = document.getElementById("result-head"),
                body = document.getElementById("result-body"),
                foot = document.getElementById("result-foot");
            while (head.firstChild) head.removeChild(head.firstChild);
            while (body.firstChild) body.removeChild(body.firstChild);
            while (foot.firstChild) foot.removeChild(foot.firstChild);

            var fields = [],
                count = 0,
                t0 = new Date();

            pub.cx.run(cypher, {}, {
                onHeader: function (metadata) {
                    $("#result-form").show();
                    var tr = document.createElement("tr");
                    for (var i = 0; i < metadata.fields.length; i++) {
                        fields.push(metadata.fields[i]);
                        var th = document.createElement("th");
                        th.appendChild(document.createTextNode(fields[i]));
                        tr.appendChild(th);
                    }
                    head.appendChild(tr)
                },
                onRecord: function (fields) {
                    count += 1;
                    var tr = document.createElement("tr");
                    for (var i = 0; i < fields.length; i++) {
                        var td = document.createElement("td");
                        var div = document.createElement("div");
                        var value = fields[i], text;
                        if (typeof value === "string") {
                            text = value;
                        }
                        else if (typeof value === "object" && !Array.isArray(value)) {
                            div.setAttribute("style", "white-space: pre");
                            text = value.constructor.name + "(" + JSON.stringify(value, null, "  ") + ")";
                        }
                        else {
                            text = JSON.stringify(value);
                        }
                        div.appendChild(document.createTextNode(text));
                        td.appendChild(div);
                        tr.appendChild(td);
                    }
                    body.appendChild(tr)
                },
                onFooter: function (metadata) {
                    var time = new Date() - t0;
                    var tr = document.createElement("tr");
                    var th = document.createElement("th");
                    th.setAttribute("colspan", "" + fields.length);
                    var server = pub.user + "@" + pub.host + ":" + pub.port;
                    th.appendChild(document.createTextNode(
                        count + " record" + (count === 1 ? "" : "s") +
                        " received from " + server + " in " + time + "ms"));
                    tr.appendChild(th);
                    foot.appendChild(tr)
                },
                onFailure: function (failure) {
                    console.log(failure.code + ": " + failure.message);
                }
            });
        }

    </script>

  </body>
</html>
